<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>DEAP optimisation &mdash; eFEL 2.6.3 documentation</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.6.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="eFEL 2.6.3 documentation" href="index.html" />
    <link rel="up" title="Python" href="python_examples.html" />
    <link rel="next" title="eFeature descriptions" href="eFeatures.html" />
    <link rel="prev" title="Quick start" href="python_example1.html" /> 
  </head>
  <body role="document">
      <div class="header"><img class="rightlogo" src="_static/bbp.png" alt="Logo"/><h1 class="heading"><a href="index.html">
          <span>eFEL 2.6.3 documentation</span></a></h1>
        <h2 class="heading"><span>DEAP optimisation</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="python_example1.html">Quick start</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="eFeatures.html">eFeature descriptions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="deap-optimisation">
<h1><a class="toc-backref" href="#id1">DEAP optimisation</a><a class="headerlink" href="#deap-optimisation" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#deap-optimisation" id="id1">DEAP optimisation</a><ul>
<li><a class="reference internal" href="#introduction" id="id2">Introduction</a></li>
<li><a class="reference internal" href="#evaluation-function" id="id3">Evaluation function</a></li>
<li><a class="reference internal" href="#setting-up-the-algorithm" id="id4">Setting up the algorithm</a></li>
<li><a class="reference internal" href="#running-the-code" id="id5">Running the code</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Using the eFEL, pyNeuron and the DEAP optimisation library one can very easily
set up a genetic algorithm to fit parameters of a neuron model.</p>
<p>We propose this setup because it leverages the power of the Python language
to load several software tools in a compact script. The DEAP
(Distributed Evolutionary Algorithms in Python) allows you to easily switch
algorithms. Parallelising your evaluation function over cluster computers
becomes a matter of only adding a couple of lines to your
<a class="reference external" href="http://deap.readthedocs.org/en/latest/tutorials/basic/part4.html">code</a>,
thanks to <a class="reference external" href="http://pyscoop.org">pyScoop</a>.</p>
<p>In this example we will assume you have installed
<a class="reference external" href="https://github.com/BlueBrain/eFEL">eFEL</a>,
<a class="reference external" href="http://www.neuron.yale.edu/neuron/download/compile_linux#otheroptions">pyNeuron</a>
and <a class="reference external" href="https://github.com/DEAP/deap">DEAP</a></p>
<p>The code of the example below can be downloaded from
<a class="reference external" href="https://github.com/BlueBrain/eFEL/tree/master/examples/deap">here</a></p>
<p>To keep the example simple, let&#8217;s start from a passive single compartmental
model. The parameters to fit will be the conductance and reversal potential
of the leak channel. We will simulate the model for 1000 ms, and at 500 ms
a step current of 1.0 nA is injected until the end of the simulation.</p>
<p>The objective values of the optimisation will be the voltage before the
current injection (i.e. the &#8216;voltage_base&#8217; feature), and the steady state
voltage during the current injection at the end of the simulation
(&#8216;steady_state_voltage&#8217;).</p>
</div>
<div class="section" id="evaluation-function">
<h2><a class="toc-backref" href="#id3">Evaluation function</a><a class="headerlink" href="#evaluation-function" title="Permalink to this headline">¶</a></h2>
<p>We now have to use pyNeuron to define the evaluation function to be optimised.
The input arguments are the parameters:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">g_pas</span><span class="p">,</span> <span class="n">e_pas</span>
</pre></div>
</div>
<p>and the return values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">abs</span><span class="p">(</span><span class="n">voltage_base</span> <span class="o">-</span> <span class="n">target_voltage1</span><span class="p">)</span>
<span class="nb">abs</span><span class="p">(</span><span class="n">steady_state_voltage</span> <span class="o">-</span> <span class="n">target_voltage2</span><span class="p">)</span>
</pre></div>
</div>
<p>This translates into the following file (let&#8217;s call it &#8216;deap_efel_eval1.py&#8217;):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">neuron</span>
<span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="s">&#39;stdrun.hoc&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">efel</span>

<span class="c"># pylint: disable=W0212</span>


<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">individual</span><span class="p">,</span> <span class="n">target_voltage1</span><span class="o">=-</span><span class="mi">80</span><span class="p">,</span> <span class="n">target_voltage2</span><span class="o">=-</span><span class="mi">60</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a neuron model with parameters e_pas and g_pas, extracts</span>
<span class="sd">    eFeatures from resulting traces and returns a tuple with</span>
<span class="sd">    abs(voltage_base-target_voltage1) and</span>
<span class="sd">    abs(steady_state_voltage-target_voltage2)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">v_init</span> <span class="o">=</span> <span class="n">target_voltage1</span>

    <span class="n">soma</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">Section</span><span class="p">()</span>

    <span class="n">soma</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;pas&#39;</span><span class="p">)</span>

    <span class="n">soma</span><span class="o">.</span><span class="n">g_pas</span> <span class="o">=</span> <span class="n">individual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">soma</span><span class="o">.</span><span class="n">e_pas</span> <span class="o">=</span> <span class="n">individual</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">clamp</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">IClamp</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="n">soma</span><span class="p">)</span>

    <span class="n">stim_start</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">stim_end</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="n">clamp</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">clamp</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">stim_start</span>
    <span class="n">clamp</span><span class="o">.</span><span class="n">dur</span> <span class="o">=</span> <span class="mi">100000</span>

    <span class="n">voltage</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">voltage</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">soma</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">_ref_v</span><span class="p">)</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">_ref_t</span><span class="p">)</span>

    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="n">stim_end</span>
    <span class="n">neuron</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">trace</span><span class="p">[</span><span class="s">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
    <span class="n">trace</span><span class="p">[</span><span class="s">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voltage</span>
    <span class="n">trace</span><span class="p">[</span><span class="s">&#39;stim_start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_start</span><span class="p">]</span>
    <span class="n">trace</span><span class="p">[</span><span class="s">&#39;stim_end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">stim_end</span><span class="p">]</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="p">[</span><span class="n">trace</span><span class="p">]</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">efel</span><span class="o">.</span><span class="n">getFeatureValues</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;voltage_base&quot;</span><span class="p">,</span>
                                             <span class="s">&quot;steady_state_voltage&quot;</span><span class="p">])</span>
    <span class="n">voltage_base</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;voltage_base&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">steady_state_voltage</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;steady_state_voltage&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">target_voltage1</span> <span class="o">-</span> <span class="n">voltage_base</span><span class="p">),</span> \
        <span class="nb">abs</span><span class="p">(</span><span class="n">target_voltage2</span> <span class="o">-</span> <span class="n">steady_state_voltage</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-algorithm">
<h2><a class="toc-backref" href="#id4">Setting up the algorithm</a><a class="headerlink" href="#setting-up-the-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Now that we have an evaluation function we just have to pass this to the DEAP
optimisation library. DEAP allows you to easily set up a genetic algorithm
to optimise your evaluation function. Let us first import all the necessary
components:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">deap</span>
<span class="kn">import</span> <span class="nn">deap.gp</span>
<span class="kn">import</span> <span class="nn">deap.benchmarks</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">creator</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">algorithms</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we define a number of constants that will be used as settings for DEAP
later:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Population size</span>
<span class="n">POP_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c"># Number of offspring in every generation</span>
<span class="n">OFFSPRING_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c"># Number of generations</span>
<span class="n">NGEN</span> <span class="o">=</span> <span class="mi">300</span>

<span class="c"># The parent and offspring population size are set the same</span>
<span class="n">MU</span> <span class="o">=</span> <span class="n">OFFSPRING_SIZE</span>
<span class="n">LAMBDA</span> <span class="o">=</span> <span class="n">OFFSPRING_SIZE</span>
<span class="c"># Crossover probability</span>
<span class="n">CXPB</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="c"># Mutation probability, should sum to one together with CXPB</span>
<span class="n">MUTPB</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="c"># Eta parameter of cx and mut operators</span>
<span class="n">ETA</span> <span class="o">=</span> <span class="mf">10.0</span>
</pre></div>
</div>
<p>We have two parameters with the following bounds:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># The size of the individual is 2 (parameters g_pas and e_pas)</span>
<span class="n">IND_SIZE</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">LOWER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-8</span><span class="p">,</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]</span>
<span class="n">UPPER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-4</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.0</span><span class="p">]</span>
</pre></div>
</div>
<p>As evolutionary algorithm we choose
<a class="reference external" href="http://www.tik.ee.ethz.ch/pisa/selectors/nsga2/nsga2_documentation.txt">NSGA2</a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">SELECTOR</span> <span class="o">=</span> <span class="s">&quot;NSGA2&quot;</span>
</pre></div>
</div>
<p>Let&#8217;s create the DEAP individual and fitness.
We set the weights of the fitness values to -1.0 so that the fitness function
will be minimised instead of maximised:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">creator</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Fitness&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">Fitness</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>The individual will just be a list (of two parameters):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">creator</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Individual&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">fitness</span><span class="o">=</span><span class="n">creator</span><span class="o">.</span><span class="n">Fitness</span><span class="p">)</span>
</pre></div>
</div>
<p>We want to start with individuals for which the parameters are picked from a
uniform random distribution. Let&#8217;s create a function that returns such a
random list based on the bounds and the dimensions of the problem:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">uniform</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill array &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span> <span class="k">for</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="ow">in</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)]</span>
</pre></div>
</div>
<p>DEAP works with the concept of &#8216;toolboxes&#8217;. The user defines genetic
algorithm&#8217;s individuals, operators, etc by registering them in a toolbox.</p>
<p>We first create the toolbox:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Toolbox</span><span class="p">()</span>
</pre></div>
</div>
<p>Then we register the &#8216;uniform&#8217; function we defined above:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;uniformparams&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">LOWER</span><span class="p">,</span> <span class="n">UPPER</span><span class="p">,</span> <span class="n">IND_SIZE</span><span class="p">)</span>
</pre></div>
</div>
<p>The three last parameters of this register call will be passed on to the
&#8216;uniform&#8217; function call</p>
<p>Now we can also register an individual:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;Individual&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">initIterate</span><span class="p">,</span>
    <span class="n">creator</span><span class="o">.</span><span class="n">Individual</span><span class="p">,</span>
    <span class="n">toolbox</span><span class="o">.</span><span class="n">uniformparams</span><span class="p">)</span>
</pre></div>
</div>
<p>And a population as list of individuals:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;population&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">.</span><span class="n">initRepeat</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">Individual</span><span class="p">)</span>
</pre></div>
</div>
<p>The function to evaluate we defined above. Assuming you saved that files as
&#8216;deap_efel_eval1.py&#8217;, we can import it as a module, and register the function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">deap_efel_eval1</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;evaluate&quot;</span><span class="p">,</span> <span class="n">deap_efel_eval1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>
</pre></div>
</div>
<p>For the mutation and crossover operator we use builtin operators that are
typically used with NSGA2:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;mate&quot;</span><span class="p">,</span>
    <span class="n">deap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">cxSimulatedBinaryBounded</span><span class="p">,</span>
    <span class="n">eta</span><span class="o">=</span><span class="n">ETA</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">LOWER</span><span class="p">,</span>
    <span class="n">up</span><span class="o">=</span><span class="n">UPPER</span><span class="p">)</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;mutate&quot;</span><span class="p">,</span> <span class="n">deap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mutPolynomialBounded</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">ETA</span><span class="p">,</span>
                 <span class="n">low</span><span class="o">=</span><span class="n">LOWER</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="n">UPPER</span><span class="p">,</span> <span class="n">indpb</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
<p>And then we specify the selector to be used:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;select&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">selNSGA2</span><span class="p">)</span>
</pre></div>
</div>
<p>We initialise the population with the size of the offspring:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pop</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">MU</span><span class="p">)</span>
</pre></div>
</div>
<p>And register some statistics we want to print during the run of the algorithm:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">first_stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">Statistics</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ind</span><span class="p">:</span> <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">second_stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">Statistics</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ind</span><span class="p">:</span> <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">MultiStatistics</span><span class="p">(</span><span class="n">obj1</span><span class="o">=</span><span class="n">first_stats</span><span class="p">,</span> <span class="n">obj2</span><span class="o">=</span><span class="n">second_stats</span><span class="p">)</span>
<span class="n">stats</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;min&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The only thing that is left now is to run the algorithm in &#8216;main&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pop</span><span class="p">,</span> <span class="n">logbook</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">eaMuPlusLambda</span><span class="p">(</span>
        <span class="n">pop</span><span class="p">,</span>
        <span class="n">toolbox</span><span class="p">,</span>
        <span class="n">MU</span><span class="p">,</span>
        <span class="n">LAMBDA</span><span class="p">,</span>
        <span class="n">CXPB</span><span class="p">,</span>
        <span class="n">MUTPB</span><span class="p">,</span>
        <span class="n">NGEN</span><span class="p">,</span>
        <span class="n">stats</span><span class="p">,</span>
        <span class="n">halloffame</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>For you convenience the full code is in a code block below. It should be saved
as &#8216;deap_efel.py&#8217;.</p>
</div>
<div class="section" id="running-the-code">
<h2><a class="toc-backref" href="#id5">Running the code</a><a class="headerlink" href="#running-the-code" title="Permalink to this headline">¶</a></h2>
<p>Assuming that the necessary dependencies are installed correctly the
optimisation can then be run with:</p>
<div class="highlight-python"><div class="highlight"><pre>python deap_efel.py
</pre></div>
</div>
<p>The full code of &#8216;deap_efel.py&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">deap</span>
<span class="kn">import</span> <span class="nn">deap.gp</span>
<span class="kn">import</span> <span class="nn">deap.benchmarks</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">base</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">creator</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">deap</span> <span class="kn">import</span> <span class="n">algorithms</span>

<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">POP_SIZE</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">OFFSPRING_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">NGEN</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">ALPHA</span> <span class="o">=</span> <span class="n">POP_SIZE</span>
<span class="n">MU</span> <span class="o">=</span> <span class="n">OFFSPRING_SIZE</span>
<span class="n">LAMBDA</span> <span class="o">=</span> <span class="n">OFFSPRING_SIZE</span>
<span class="n">CXPB</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">MUTPB</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">ETA</span> <span class="o">=</span> <span class="mf">10.0</span>

<span class="n">SELECTOR</span> <span class="o">=</span> <span class="s">&quot;NSGA2&quot;</span>

<span class="n">IND_SIZE</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">LOWER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-8</span><span class="p">,</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]</span>
<span class="n">UPPER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e-4</span><span class="p">,</span> <span class="o">-</span><span class="mf">20.0</span><span class="p">]</span>

<span class="n">creator</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Fitness&quot;</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">Fitness</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">creator</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&quot;Individual&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">fitness</span><span class="o">=</span><span class="n">creator</span><span class="o">.</span><span class="n">Fitness</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">uniform</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fill array &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span> <span class="k">for</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="ow">in</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower_list</span><span class="p">,</span> <span class="n">upper_list</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)]</span>

<span class="n">toolbox</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">Toolbox</span><span class="p">()</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;uniformparams&quot;</span><span class="p">,</span> <span class="n">uniform</span><span class="p">,</span> <span class="n">LOWER</span><span class="p">,</span> <span class="n">UPPER</span><span class="p">,</span> <span class="n">IND_SIZE</span><span class="p">)</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;Individual&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">initIterate</span><span class="p">,</span>
    <span class="n">creator</span><span class="o">.</span><span class="n">Individual</span><span class="p">,</span>
    <span class="n">toolbox</span><span class="o">.</span><span class="n">uniformparams</span><span class="p">)</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;population&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">.</span><span class="n">initRepeat</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">Individual</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">deap_efel_eval1</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;evaluate&quot;</span><span class="p">,</span> <span class="n">deap_efel_eval1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">)</span>

<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;mate&quot;</span><span class="p">,</span>
    <span class="n">deap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">cxSimulatedBinaryBounded</span><span class="p">,</span>
    <span class="n">eta</span><span class="o">=</span><span class="n">ETA</span><span class="p">,</span>
    <span class="n">low</span><span class="o">=</span><span class="n">LOWER</span><span class="p">,</span>
    <span class="n">up</span><span class="o">=</span><span class="n">UPPER</span><span class="p">)</span>
<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;mutate&quot;</span><span class="p">,</span> <span class="n">deap</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mutPolynomialBounded</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">ETA</span><span class="p">,</span>
                 <span class="n">low</span><span class="o">=</span><span class="n">LOWER</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="n">UPPER</span><span class="p">,</span> <span class="n">indpb</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;variate&quot;</span><span class="p">,</span> <span class="n">deap</span><span class="o">.</span><span class="n">algorithms</span><span class="o">.</span><span class="n">varAnd</span><span class="p">)</span>

<span class="n">toolbox</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
    <span class="s">&quot;select&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">selNSGA2</span><span class="p">)</span>

<span class="n">pop</span> <span class="o">=</span> <span class="n">toolbox</span><span class="o">.</span><span class="n">population</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">MU</span><span class="p">)</span>

<span class="n">first_stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">Statistics</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ind</span><span class="p">:</span> <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">second_stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">Statistics</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ind</span><span class="p">:</span> <span class="n">ind</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">stats</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">MultiStatistics</span><span class="p">(</span><span class="n">obj1</span><span class="o">=</span><span class="n">first_stats</span><span class="p">,</span> <span class="n">obj2</span><span class="o">=</span><span class="n">second_stats</span><span class="p">)</span>
<span class="n">stats</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;min&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">pop</span><span class="p">,</span> <span class="n">logbook</span> <span class="o">=</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">eaMuPlusLambda</span><span class="p">(</span>
        <span class="n">pop</span><span class="p">,</span>
        <span class="n">toolbox</span><span class="p">,</span>
        <span class="n">MU</span><span class="p">,</span>
        <span class="n">LAMBDA</span><span class="p">,</span>
        <span class="n">CXPB</span><span class="p">,</span>
        <span class="n">MUTPB</span><span class="p">,</span>
        <span class="n">NGEN</span><span class="p">,</span>
        <span class="n">stats</span><span class="p">,</span>
        <span class="n">halloffame</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="python_example1.html">Quick start</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="eFeatures.html">eFeature descriptions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, BBP, EPFL.
      Last updated on Sep 01, 2015.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>